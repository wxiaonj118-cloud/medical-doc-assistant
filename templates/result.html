{% extends "base.html" %}

{% block title %}Analysis Results - Medical Assistant{% endblock %}

{% block content %}
<div class="apple-container">
    <!-- Result Hero -->
    <section class="hero-section">
        <div class="hero-content">
            <div class="hero-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h1 class="hero-title">Analysis Results</h1>
            <p class="hero-subtitle">AI-powered insights from your medical document</p>
        </div>
    </section>

    <!-- Results Content -->
    <section class="results-section">
        {% if analysis %}
        <!-- Demo mode with sample data -->
        <div class="result-card">
            <div class="result-header">
                <div class="result-meta">
                    <span><i class="fas fa-file"></i> sample_blood_test.pdf</span>
                    <span><i class="fas fa-clock"></i> Analyzed just now</span>
                </div>
                <h2>AI Analysis Report</h2>
            </div>
            
            <div class="result-content">
                <div class="analysis-section">
                    <h3><i class="fas fa-stethoscope"></i> Key Findings</h3>
                    <div class="analysis-text">
                        {{ analysis.analysis if analysis.analysis is string else analysis.analysis|safe }}
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="apple-button" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Upload
                    </button>
                    <button class="apple-button primary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <a href="{{ url_for('home') }}" class="apple-button secondary">
                        <i class="fas fa-upload"></i> New Upload
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Real results would go here -->
        <div class="result-card">
            <div class="result-header">
                <h2>No Analysis Available</h2>
                <p>Upload a document or paste text to get AI analysis</p>
            </div>
            <div class="action-buttons">
                <a href="{{ url_for('home') }}" class="apple-button primary">
                    <i class="fas fa-upload"></i> Upload Document
                </a>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Tips Section -->
    <section class="tips-section">
        <h2><i class="fas fa-lightbulb"></i> Next Steps & Recommendations</h2>
        <div class="tips-grid">
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-user-md"></i>
                </div>
                <h3>Consult Your Doctor</h3>
                <p>Share this analysis with your healthcare provider for professional interpretation.</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h3>Prepare Questions</h3>
                <p>Use the generated questions as a starting point for your doctor's appointment.</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <h3>Schedule Follow-up</h3>
                <p>Consider scheduling appropriate follow-up tests or appointments.</p>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Format analysis text for better mobile display - ENHANCED
    document.addEventListener('DOMContentLoaded', function() {
        const analysisText = document.querySelector('.analysis-text');
        if (analysisText) {
            let text = analysisText.innerHTML;
            
            // First, protect existing HTML tags
            const tagRegex = /<[^>]*>/g;
            const tags = [];
            let tagIndex = 0;
            text = text.replace(tagRegex, function(match) {
                tags[tagIndex] = match;
                return `___TAG${tagIndex++}___`;
            });
            
            // Convert markdown-like formatting
            text = text.replace(/### (.*?)(?:___TAG|$)/g, '<h4>$1</h4>');
            text = text.replace(/## (.*?)(?:___TAG|$)/g, '<h3>$1</h3>');
            text = text.replace(/# (.*?)(?:___TAG|$)/g, '<h3>$1</h3>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Handle numbered sections (1. üìä **Key Values**)
            text = text.replace(/(\d+\.\s*[üìäüîçüè•üíä‚ö†Ô∏è‚ùìüìã]?\s*\*\*.*?\*\*)/g, '<div class="section-title">$1</div>');
            
            // Replace dash bullets with proper bullets
            text = text.replace(/^- /gm, '‚Ä¢ ');
            
            // Restore HTML tags
            text = text.replace(/___TAG(\d+)___/g, function(match, index) {
                return tags[index] || match;
            });
            
            // Split into lines and rebuild with proper HTML structure
            const lines = text.split('\n');
            let formattedText = '';
            let inList = false;
            let listType = null;
            
            for (let line of lines) {
                line = line.trim();
                
                // Check if this is a list item (bullet or numbered)
                if (line.startsWith('‚Ä¢ ')) {
                    // Bullet list item
                    if (!inList || listType !== 'ul') {
                        if (inList) formattedText += `</${listType}>`;
                        formattedText += '<ul class="analysis-list">';
                        inList = true;
                        listType = 'ul';
                    }
                    // Extract the content after the bullet
                    const content = line.substring(2);
                    formattedText += `<li>${content}</li>`;
                } 
                else if (line.match(/^\d+\.\s/)) {
                    // Numbered list item
                    if (!inList || listType !== 'ol') {
                        if (inList) formattedText += `</${listType}>`;
                        formattedText += '<ol class="analysis-list">';
                        inList = true;
                        listType = 'ol';
                    }
                    // Extract the content after the number
                    const content = line.replace(/^\d+\.\s/, '');
                    formattedText += `<li>${content}</li>`;
                }
                else {
                    // Not a list item
                    if (inList) {
                        formattedText += `</${listType}>`;
                        inList = false;
                        listType = null;
                    }
                    
                    if (line.length > 0) {
                        // Check if it's a section title (already wrapped)
                        if (line.includes('section-title')) {
                            formattedText += line;
                        } 
                        // Check if it's a heading
                        else if (line.startsWith('<h3') || line.startsWith('<h4')) {
                            formattedText += line;
                        }
                        // Regular paragraph
                        else {
                            formattedText += `<p>${line}</p>`;
                        }
                    }
                }
            }
            
            // Close any open list
            if (inList) {
                formattedText += `</${listType}>`;
            }
            
            analysisText.innerHTML = formattedText;
            
            // Add mobile optimization class
            analysisText.classList.add('mobile-optimized');
            
            // Additional fix: Add span with word-break to any text node that might contain long words
            function addWordBreakToTextNodes(element) {
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            // Only process text nodes with content
                            if (node.textContent.trim().length > 0) {
                                return NodeFilter.FILTER_ACCEPT;
                            }
                            return NodeFilter.FILTER_REJECT;
                        }
                    }
                );
                
                const textNodes = [];
                while (walker.nextNode()) {
                    textNodes.push(walker.currentNode);
                }
                
                textNodes.forEach(textNode => {
                    const parent = textNode.parentNode;
                    if (parent && parent.tagName !== 'LI' && parent.tagName !== 'P' && parent.tagName !== 'H3' && parent.tagName !== 'H4') {
                        const span = document.createElement('span');
                        span.style.wordBreak = 'break-word';
                        span.style.overflowWrap = 'break-word';
                        span.style.display = 'inline';
                        span.textContent = textNode.textContent;
                        parent.replaceChild(span, textNode);
                    }
                });
            }
            
            addWordBreakToTextNodes(analysisText);
        }
    });
    
    // Add CSS rule for long words dynamically
    const style = document.createElement('style');
    style.textContent = `
        .analysis-text li, .analysis-text p {
            word-break: break-word !important;
            overflow-wrap: break-word !important;
            -webkit-hyphens: auto !important;
            hyphens: auto !important;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}